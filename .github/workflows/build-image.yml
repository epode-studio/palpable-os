name: Build Palpable OS Image

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Setup DietPi environment
        run: |
          # Create symlink so dietpi-build can find dietpi-globals locally
          sudo mkdir -p /boot
          sudo ln -s "$PWD/dietpi" /boot/dietpi
          # Temporarily rename rootfs directory to avoid conflict with build script
          mv rootfs rootfs_custom

      - name: Build Palpable OS for Raspberry Pi
        run: |
          echo "Building Palpable OS for Raspberry Pi 2/3/4/5 (ARMv8, Bookworm)..."
          # Model 2 = Raspberry Pi 2/3/4/5, -d 8 = Bookworm
          # Export all required environment variables for dietpi-build
          export G_GITOWNER=$GITHUB_REPOSITORY_OWNER
          export G_GITREPO=palpable-os
          export G_GITBRANCH=master
          export G_HW_ARCH_NAME=$(uname -m)
          sudo -E bash ./.build/images/dietpi-build -m 2 -d 8
          # Restore rootfs directory name
          mv rootfs_custom rootfs

      - name: Rename and compress image
        run: |
          echo "Finding built image..."
          # Find the generated image file (search for any DietPi RPi image)
          IMAGE=$(find . -maxdepth 1 -name "DietPi_RPi*.img" -type f | head -n 1)

          if [ -z "$IMAGE" ]; then
            echo "Error: No image file found!"
            ls -la *.img || echo "No .img files found"
            exit 1
          fi

          echo "Found image: $IMAGE"

          # Rename to Palpable OS naming
          NEW_NAME="palpable-os-${{ steps.version.outputs.VERSION }}.img"
          mv "$IMAGE" "$NEW_NAME"

          echo "Compressing image..."
          xz -9 -T0 "$NEW_NAME"

          # Calculate checksum
          sha256sum "${NEW_NAME}.xz" > "${NEW_NAME}.xz.sha256"

          echo "Build complete: ${NEW_NAME}.xz"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: Palpable OS ${{ steps.version.outputs.VERSION }}
          body: |
            ## Palpable OS ${{ steps.version.outputs.VERSION }}

            Smart Home Sensor Platform for Raspberry Pi

            ### Download

            Download `palpable-os-${{ steps.version.outputs.VERSION }}.img.xz` and flash it to your SD card using:
            - [Palpable Imager](https://github.com/epode-studio/palpable-imager/releases) (recommended)
            - [Raspberry Pi Imager](https://www.raspberrypi.com/software/)
            - [Balena Etcher](https://www.balena.io/etcher/)

            ### What's included

            - Based on DietPi (Bookworm, 64-bit)
            - Pre-configured for Palpable sensors
            - Auto-installs Node.js and I2C tools
            - Connects to Palpable cloud on first boot
            - Compatible with Raspberry Pi 2, 3, 4, and 5

            ### First boot

            1. Flash the image to your SD card
            2. Copy your `palpable-device.json` and WiFi config files to the boot partition (optional)
            3. Insert SD card and power on
            4. Device will auto-configure and appear in your Palpable dashboard

            ### Checksum

            Verify your download with: `sha256sum -c palpable-os-${{ steps.version.outputs.VERSION }}.img.xz.sha256`
          files: |
            palpable-os-${{ steps.version.outputs.VERSION }}.img.xz
            palpable-os-${{ steps.version.outputs.VERSION }}.img.xz.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact (for workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: palpable-os-${{ steps.version.outputs.VERSION }}
          path: |
            palpable-os-${{ steps.version.outputs.VERSION }}.img.xz
            palpable-os-${{ steps.version.outputs.VERSION }}.img.xz.sha256
