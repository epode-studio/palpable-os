name: Build Palpable OS Image

on:
  push:
    branches: [main]
    paths:
      - 'build.sh'
      - 'rootfs-overlay/**'
      - 'scripts/**'
      - 'configs/**'
      - '.github/workflows/build-image.yml'
    tags:
      - 'v*'

  workflow_dispatch:
    inputs:
      version:
        description: 'Version override (e.g., 2024.12.29)'
        required: false
        default: ''

  # Trigger when Go agent is updated
  repository_dispatch:
    types: [agent-release]

env:
  ALPINE_VERSION: "3.21"
  IMAGE_NAME: palpable-os

jobs:
  build-agent:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout palpable monorepo
        uses: actions/checkout@v4
        with:
          repository: epode-studio/palpable
          path: palpable

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build palpable-agent for ARM64
        run: |
          cd palpable/palpable-agent-go
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build \
            -ldflags="-s -w -X main.Version=${{ github.sha }}" \
            -o palpable-agent-linux-arm64 \
            ./cmd/palpable-agent

      - name: Upload agent artifact
        uses: actions/upload-artifact@v4
        with:
          name: palpable-agent
          path: palpable/palpable-agent-go/palpable-agent-linux-arm64

  build-image:
    runs-on: ubuntu-latest
    needs: build-agent

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download agent
        uses: actions/download-artifact@v4
        with:
          name: palpable-agent
          path: cache/

      - name: Set version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=$(date +%Y.%m.%d)" >> $GITHUB_OUTPUT
          fi

      - name: Build OS image
        run: |
          chmod +x cache/palpable-agent
          sudo VERSION=${{ steps.version.outputs.version }} \
               IMAGE_NAME=${{ env.IMAGE_NAME }} \
               ALPINE_VERSION=${{ env.ALPINE_VERSION }} \
               ./build.sh

      - name: Generate checksums
        run: |
          cd output
          sha256sum *.img > ${{ env.IMAGE_NAME }}-${{ steps.version.outputs.version }}.img.sha256
          sha256sum *.img.xz > ${{ env.IMAGE_NAME }}-${{ steps.version.outputs.version }}.img.xz.sha256

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: palpable-os-image
          path: |
            output/*.img.xz
            output/*.sha256

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          name: Palpable OS ${{ steps.version.outputs.version }}
          body: |
            ## Palpable OS ${{ steps.version.outputs.version }}

            Minimal Alpine Linux-based OS for Raspberry Pi Zero 2 W with:
            - A/B root partitions for atomic updates
            - Read-only root filesystem
            - WiFi provisioning via captive portal
            - Palpable agent pre-installed

            ### Quick Start
            ```bash
            # Decompress and flash to SD card
            xzcat ${{ env.IMAGE_NAME }}-${{ steps.version.outputs.version }}.img.xz | sudo dd of=/dev/sdX bs=4M status=progress
            ```

            ### First Boot
            1. Insert SD card and power on
            2. Connect to "Palpable-XXXX" WiFi
            3. Visit http://192.168.4.1 to configure

            **Built:** $(date -u +"%Y-%m-%d %H:%M UTC")
          files: |
            output/${{ env.IMAGE_NAME }}-${{ steps.version.outputs.version }}.img.xz
            output/${{ env.IMAGE_NAME }}-${{ steps.version.outputs.version }}.img.xz.sha256
            output/${{ env.IMAGE_NAME }}-${{ steps.version.outputs.version }}.img.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Notify palpable-bootstrap to rebuild with new OS
      - name: Trigger bootstrap rebuild
        if: startsWith(github.ref, 'refs/tags/v')
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.PALPABLE_PAT }}
          repository: epode-studio/palpable-bootstrap
          event-type: palpable-os-release
          client-payload: '{"version": "${{ steps.version.outputs.version }}"}'

  # Also build and publish latest on every push to main
  publish-latest:
    runs-on: ubuntu-latest
    needs: build-image
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download image
        uses: actions/download-artifact@v4
        with:
          name: palpable-os-image
          path: output/

      - name: Update latest release
        run: |
          VERSION=$(date +%Y.%m.%d)

          # Delete existing latest release
          gh release delete latest --yes 2>/dev/null || true
          git push --delete origin latest 2>/dev/null || true

          # Create new latest release
          gh release create latest output/*.img.xz output/*.sha256 \
            --title "Palpable OS Latest (${VERSION})" \
            --notes "## Palpable OS - Latest Build

          Automatic build from main branch.

          **Version:** ${VERSION}
          **Built:** $(date -u +'%Y-%m-%d %H:%M UTC')

          For stable releases, see the versioned tags."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
